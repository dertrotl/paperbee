# .github/workflows/daily-papers.yml
name: Paper Fetch (Back to Working Version)

on:
  schedule:
    - cron: '0 9 * * 1-5'  # Monday-Friday at 9 AM UTC
  workflow_dispatch:

jobs:
  fetch-papers:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          
      - name: Install dependencies
        run: |
          pip install -e .  # Your modified fork (ONLY for Gemini support)
          
      - name: Create Google credentials file
        run: |
          echo '${{ secrets.GOOGLE_CREDENTIALS_JSON }}' > google-credentials.json
          
      - name: Determine search window
        id: search_days
        run: |
          DAY_OF_WEEK=$(date +%u)
          if [ "$DAY_OF_WEEK" -eq 1 ]; then
            echo "since_days=2" >> $GITHUB_OUTPUT
            echo "Monday: 2 days"
          else
            echo "since_days=1" >> $GITHUB_OUTPUT
            echo "Weekday: 1 day"  
          fi
          
      - name: Create simple config (like before, but with Gemini support)
        run: |
          cat > config.yml << 'EOF'
          GOOGLE_SPREADSHEET_ID: "${{ secrets.GOOGLE_SPREADSHEET_ID }}"
          GOOGLE_CREDENTIALS_JSON: "./google-credentials.json"
          NCBI_API_KEY: "${{ secrets.NCBI_API_KEY }}"
          LOCAL_ROOT_DIR: "."
          
          # Use your WORKING single query (not separated)
          query: "[single-cell RNA sequencing] OR [spatial transcriptomics] OR [single-cell analysis] OR [scRNA-seq] OR [single cell atlas] OR [single-cell integration] OR [fibrosis] OR [IBD] OR [lung health] OR [COPD]"
          
          # LLM Filtering with Gemini (the ONLY thing we're fixing)
          LLM_FILTERING: true
          LLM_PROVIDER: "openai"
          LANGUAGE_MODEL: "gemini-2.0-flash-light"
          OPENAI_API_KEY: "${{ secrets.GEMINI_API_KEY }}"
          OPENAI_BASE_URL: "https://generativelanguage.googleapis.com/v1beta/openai/"
          
          FILTERING_PROMPT: "${{ secrets.FILTERING_PROMPT || 'You are a research assistant. Is this paper relevant to single-cell biology and IBD research? Answer only yes or no.' }}"
          
          SLACK:
            is_posting_on: true
            bot_token: "${{ secrets.SLACK_BOT_TOKEN }}"
            channel_id: "${{ secrets.SLACK_CHANNEL_ID }}"
            app_token: "${{ secrets.SLACK_APP_TOKEN }}"
          
          TELEGRAM:
            is_posting_on: false
          ZULIP:
            is_posting_on: false
          EOF
          
      - name: Debug config
        run: |
          echo "=== Config ==="
          cat config.yml
          echo ""
          echo "Search window: ${{ steps.search_days.outputs.since_days }} days"
          
      - name: Run PaperBee (simple approach)
        run: |
          echo "Using SIMPLE single query approach (like before)"
          echo "Search window: ${{ steps.search_days.outputs.since_days }} days"
          paperbee post --config config.yml --since ${{ steps.search_days.outputs.since_days }}
          
      - name: Clean up
        if: always()
        run: |
          rm -f google-credentials.json config.yml
