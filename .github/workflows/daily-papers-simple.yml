# .github/workflows/daily-papers-simple.yml
name: Daily Paper Fetch (Gemini)

on:
  schedule:
    - cron: '0 9 * * *'  # Daily at 9 AM UTC
  workflow_dispatch:

jobs:
  fetch-papers:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          
      - name: Install dependencies
        run: pip install paperbee
          
      - name: Create secure config
        env:
          GOOGLE_CREDS: ${{ secrets.GOOGLE_CREDENTIALS_JSON }}
          GOOGLE_SHEET_ID: ${{ secrets.GOOGLE_SPREADSHEET_ID }}
          NCBI_KEY: ${{ secrets.NCBI_API_KEY }}
          GEMINI_KEY: ${{ secrets.GEMINI_API_KEY }}
          SLACK_BOT: ${{ secrets.SLACK_BOT_TOKEN }}
          SLACK_CHANNEL: ${{ secrets.SLACK_CHANNEL_ID }}
          SLACK_APP: ${{ secrets.SLACK_APP_TOKEN }}
        run: |
          # Create credentials file securely
          echo "$GOOGLE_CREDS" > google-credentials.json
          
          # Create config with environment variables
          cat > config.yml << 'EOF'
          GOOGLE_SPREADSHEET_ID: "${GOOGLE_SHEET_ID}"
          GOOGLE_CREDENTIALS_JSON: "./google-credentials.json"
          NCBI_API_KEY: "${NCBI_KEY}"
          LOCAL_ROOT_DIR: "."
          
          # Your research focus - customize this!
          query: "[machine learning] OR [artificial intelligence] OR [deep learning] OR [neural networks]"
          
          # LLM Filtering with Gemini (free tier: 1,500 requests/day)
          LLM_FILTERING: true
          LLM_PROVIDER: "openai"
          LANGUAGE_MODEL: "gemini-1.5-flash"
          OPENAI_API_KEY: "${GEMINI_KEY}"
          OPENAI_BASE_URL: "https://generativelanguage.googleapis.com/v1beta/openai/"
          
          FILTERING_PROMPT: "You are a research assistant. Is this paper relevant to machine learning/AI research? Answer only 'yes' or 'no'."
          
          SLACK:
            is_posting_on: true
            bot_token: "${SLACK_BOT}"
            channel_id: "${SLACK_CHANNEL}"
            app_token: "${SLACK_APP}"
          
          TELEGRAM:
            is_posting_on: false
          ZULIP:
            is_posting_on: false
          EOF
          
          # Substitute environment variables
          envsubst < config.yml > config_final.yml
          
      - name: Run PaperBee
        run: |
          paperbee post --config config_final.yml --since 1
          
      - name: Clean up
        if: always()
        run: |
          rm -f google-credentials.json config.yml config_final.yml
