# .github/workflows/daily-papers-simple.yml
name: PaperBee Daily Digest Clinic

on:
  schedule:
    - cron: '0 7 * * 1-5'  # Monday-Friday at 7 AM UTC
  workflow_dispatch:

jobs:
  fetch-papers:
    runs-on: ubuntu-latest
    timeout-minutes: 120
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          
      - name: Install dependencies
        run: |
          pip install -e .
          
      - name: Create Google credentials file
        run: |
          echo '${{ secrets.GOOGLE_CREDENTIALS_JSON }}' > google-credentials.json
          
      - name: Determine search window
        id: search_days
        run: |
          DAY_OF_WEEK=$(date +%u)
          if [ "$DAY_OF_WEEK" -eq 1 ]; then
            echo "since_days=2" >> $GITHUB_OUTPUT
          else
            echo "since_days=1" >> $GITHUB_OUTPUT
          fi
          
      - name: Run PaperBee Pipeline
        env:
          GOOGLE_SHEET_ID: ${{ secrets.GOOGLE_SPREADSHEET_ID }}
          NCBI_KEY: ${{ secrets.NCBI_API_KEY }}
          GEMINI_KEY: ${{ secrets.GEMINI_API_KEY }}
          SLACK_BOT: ${{ secrets.SLACK_BOT_TOKEN }}
          SLACK_CHANNEL: ${{ secrets.SLACK_CHANNEL_ID }}
          SLACK_APP: ${{ secrets.SLACK_APP_TOKEN }}
          PAPERBEE_GROUP_NAME: "Clinic Research"
          PAPERBEE_GROUP_EMOJI: "ğŸ¥"
        run: |
          echo "ğŸ¥ Starting PaperBee Clinic Research Digest"
          echo "ğŸ“… Search window: ${{ steps.search_days.outputs.since_days }} days"
          echo ""
          
          python3 << 'EOF'
          import yaml
          import os
          import subprocess
          
          # Create comprehensive clinic research config
          config = {
              "GOOGLE_SPREADSHEET_ID": os.environ.get("GOOGLE_SHEET_ID", ""),
              "GOOGLE_CREDENTIALS_JSON": "./google-credentials.json",
              "NCBI_API_KEY": os.environ.get("NCBI_KEY", ""),
              "LOCAL_ROOT_DIR": ".",
              "databases": ["pubmed", "biorxiv"],
              
              # Clinic-focused queries (Single-cell, IBD, Immunology) - OPTIMIZED
              "query_biorxiv": "[single-cell] OR [scRNA-seq] OR [spatial transcriptomics] OR [organoids] OR [IBD] OR [inflammatory bowel disease] OR [Crohn] OR [ulcerative colitis] OR [immunodeficiency] OR [inflammasome] OR [immunology] OR [autoimmune] OR [multiomics] OR [computational biology] OR [pertubations] OR [proteomics]",
              
              "query_pubmed_arxiv": "([single-cell RNA sequencing] OR [spatial] OR [spatial transcriptomics] OR [pertubations] OR [proteomics] OR [scRNA-seq] OR [immunodeficiency] OR [inflammasome] OR [organoids] OR [multiomics] OR [computational biology] OR [immunology] OR [autoimmune]) AND ([IBD] OR [inflammatory bowel disease] OR [Crohn's disease] OR [ulcerative colitis] OR [VEO-IBD])",
              
              "limit": 600,
              "limit_per_database": 200,
              
              "LLM_FILTERING": True,
              "LLM_PROVIDER": "openai",
              "LANGUAGE_MODEL": "gemini-2.5-flash-lite",
              "OPENAI_API_KEY": os.environ.get("GEMINI_KEY", ""),
              "OPENAI_BASE_URL": "https://generativelanguage.googleapis.com/v1beta/openai/",
              
              "FILTERING_PROMPT": "You are reviewing research papers for a lab focused on single-cell analysis, IBD/immunology, and computational biology. Key interests: single-cell RNA-seq, organoids, everything related to veo-ibd,inflammatory bowel disease, immunodeficiency, inflammasome biology, and autoimmune diseases. Be INCLUSIVE - if a paper relates to single-cell methods, IBD, immunology, organoids, or computational biology approaches in these areas as well as single cell seq, spatial transcriptomics and proteomics, it is likely relevant. Answer 'yes' or 'no': Is this paper relevant?",
              
              # Enable paper categorization for Slack posting
              "CATEGORIZE_PAPERS": True,
              "CATEGORY_PROMPT": "Categorize this research paper into ONE of these three categories: 1) 'Bioinformatics/Computational' - papers focused on computational methods, algorithms, machine learning, bioinformatics tools, data analysis pipelines, mathematical modeling, or software development. 2) 'Wetlab' - papers focused on experimental techniques, laboratory methods, molecular biology, cell culture, animal models, or bench science. 3) 'Clinical' - papers focused on clinical studies, patient cohorts, clinical trials, diagnostic applications, therapeutic interventions, or translational medicine. Answer with ONLY ONE WORD: Bioinformatics, Wetlab, or Clinical.",
              
              "SLACK": {
                  "is_posting_on": False,  # Disable built-in posting, we'll do custom categorized posting
                  "bot_token": os.environ.get("SLACK_BOT", ""),
                  "channel_id": os.environ.get("SLACK_CHANNEL", ""),
                  "app_token": os.environ.get("SLACK_APP", "")
              },
              "TELEGRAM": {"is_posting_on": False},
              "ZULIP": {"is_posting_on": False}
          }
          
          # Save config
          with open("config_clinic.yml", "w") as f:
              yaml.dump(config, f, default_flow_style=False)
          
          # Debug: Check saved config file
          print(f"ğŸ” DEBUG - Saved YAML config content:")
          with open("config_clinic.yml", "r") as f:
              saved_config = f.read()
              print(saved_config[:500] + "..." if len(saved_config) > 500 else saved_config)
          
          print(f"ğŸ¥ Clinic Research Configuration:")
          print(f"   ğŸ§¬ BioRxiv query: {config['query_biorxiv'][:100]}...")
          print(f"   ğŸ“„ PubMed/ArXiv query: {config['query_pubmed_arxiv'][:100]}...")
          print(f"   ğŸ“Š Limits: total={config['limit']}, per_db={config['limit_per_database']}")
          print(f"   ğŸ—ƒï¸ Databases: {config['databases']}")
          print(f"   ğŸ¤– LLM: {config['LANGUAGE_MODEL']}")
          print(f"   ğŸ” DEBUG - Full config databases value: {repr(config['databases'])}")
          print(f"   ğŸ” DEBUG - Type of databases: {type(config['databases'])}")
          
          # Run PaperBee
          try:
              print(f"\nğŸš€ Starting PaperBee for Clinic Research...")
              print(f"ğŸ“… Search window: ${{ steps.search_days.outputs.since_days }} days")
              
              result = subprocess.run([
                  "paperbee", "post", 
                  "--config", "config_clinic.yml", 
                  "--since", "${{ steps.search_days.outputs.since_days }}"
              ], capture_output=True, text=True, timeout=3000)  # 50 min timeout
              
              print(f"\nğŸ“¤ PaperBee output:")
              print("="*60)
              print(result.stdout)
              if result.stderr:
                  print(f"âš ï¸ Stderr: {result.stderr}")
              print("="*60)
              
              if result.returncode == 0:
                  print(f"âœ… Clinic Research completed successfully")
                  
                  # Parse results
                  output_lines = result.stdout.split('\n')
                  paper_count = 0
                  raw_count = 0
                  
                  for line in output_lines:
                      if 'papers selected after filtering' in line.lower():
                          try:
                              paper_count = int(line.split()[0])
                          except:
                              pass
                      elif 'found' in line.lower() and 'articles' in line.lower():
                          try:
                              numbers = [int(s) for s in line.split() if s.isdigit()]
                              if numbers:
                                  raw_count += numbers[0]
                          except:
                              pass
                  
                  print(f"ğŸ“ˆ Results: {raw_count} raw papers â†’ {paper_count} filtered papers")
                  
              else:
                  print(f"âŒ Clinic Research failed with return code {result.returncode}")
                  print(f"Error details: {result.stderr}")
                  
          except subprocess.TimeoutExpired:
              print(f"â° Clinic Research timed out after 50 minutes")
          except Exception as e:
              print(f"ğŸ’¥ Clinic Research error: {str(e)}")
          
          # Clean up
          try:
              os.remove("config_clinic.yml")
          except:
              pass
          
          EOF
          
      - name: Post Categorized Papers to Slack
        env:
          SLACK_BOT: ${{ secrets.SLACK_BOT_TOKEN }}
          SLACK_CHANNEL: ${{ secrets.SLACK_CHANNEL_ID }}
          GEMINI_KEY: ${{ secrets.GEMINI_API_KEY }}
          GOOGLE_SHEET_ID: ${{ secrets.GOOGLE_SPREADSHEET_ID }}
        run: |
          echo "ğŸ“¤ Posting categorized papers to Slack..."
          
          python3 << 'EOF'
          import os
          import sys
          from datetime import date
          from slack_sdk import WebClient
          from openai import OpenAI
          
          # Add src to path
          sys.path.insert(0, os.path.join(os.getcwd(), 'src'))
          
          from PaperBee.papers.categorized_slack_formatter import CategorizedSlackPaperPublisher
          from PaperBee.papers.google_sheet import GoogleSheetsUpdater
          from PaperBee.papers.utils import Logger
          
          try:
              # Initialize clients
              slack_client = WebClient(token=os.environ.get("SLACK_BOT", ""))
              llm_client = OpenAI(
                  api_key=os.environ.get("GEMINI_KEY", ""),
                  base_url="https://generativelanguage.googleapis.com/v1beta/openai/"
              )
              logger = Logger("CategorizedSlackPoster")
              
              # Get today's papers from Google Sheets
              today_str = date.today().strftime("%Y-%m-%d")
              
              sheet_updater = GoogleSheetsUpdater(
                  spreadsheet_id=os.environ.get("GOOGLE_SHEET_ID", ""),
                  credentials_json_path="./google-credentials.json"
              )
              
              # Read the sheet and get papers data
              sheet_result = sheet_updater.open_sheet("Papers")
              if sheet_result is None:
                  logger.error("âŒ Could not open Google Sheet")
                  sys.exit(1)
              
              sheet, nr_rows = sheet_result
              all_data = sheet.get_all_values()
              
              # Filter for today's papers (assuming date is in column 3, index 2)
              # Format: [DOI, pub_date, search_date, is_preprint, title, abstract, source, keywords, url]
              today_papers = [row for row in all_data[1:] if len(row) > 2 and row[2] == today_str]
              
              logger.info(f"ğŸ“Š Found {len(today_papers)} papers from today ({today_str})")
              
              if today_papers:
                  # Create categorized publisher
                  publisher = CategorizedSlackPaperPublisher(
                      client=slack_client,
                      logger=logger,
                      channel_id=os.environ.get("SLACK_CHANNEL", ""),
                      llm_client=llm_client
                  )
                  
                  # Post categorized papers
                  response = publisher.post_categorized_papers(
                      papers_list=today_papers,
                      group_name="ğŸ¥ Clinic Research Papers",
                      publish_date=today_str
                  )
                  
                  logger.info(f"âœ… Successfully posted categorized papers to Slack")
              else:
                  logger.info("â„¹ï¸ No papers found for today, skipping Slack post")
                  
          except Exception as e:
              print(f"âŒ Error posting categorized papers: {e}")
              import traceback
              traceback.print_exc()
              sys.exit(1)
          
          EOF
      
      - name: Clean up
        if: always()
        run: |
          rm -f google-credentials.json config_clinic.yml
